<% content_for :page_header do %>
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-2xl font-bold text-primary">Items Fijos</h1>
      <p class="text-secondary">Ingresos y gastos fijos mensuales - <%= period_name %></p>
    </div>
    <div class="flex items-center gap-2">
      <%= button_to "Copiar del mes anterior",
        copy_from_previous_household_line_items_path(period: period_param),
        method: :post,
        data: { turbo_confirm: "¿Copiar todos los items del mes anterior?" },
        class: "px-3 py-2 text-sm border border-secondary rounded-lg hover:bg-container-inset transition-colors" %>
      <%= render DS::Link.new(
        text: "Agregar Item",
        href: new_household_line_item_path(period: period_param),
        variant: "primary",
        icon: "plus"
      ) %>
    </div>
  </div>
<% end %>

<%= render "household/shared/period_nav" %>

<% if @line_items.any? %>
  <%# Group by kind (income/expense) then by category %>
  <% grouped = @line_items.group_by(&:kind) %>

  <%# Incomes Section %>
  <% if grouped["income"]&.any? %>
    <div class="bg-container rounded-xl shadow-border-xs overflow-hidden mb-6">
      <div class="px-4 py-3 bg-green-50 border-b border-green-200 theme-dark:bg-green-900/20 theme-dark:border-green-800">
        <h3 class="font-semibold text-green-700 flex items-center gap-2 theme-dark:text-green-300">
          <%= icon("trending-up", class: "w-5 h-5") %>
          Ingresos
          <span class="ml-auto text-lg">
            <%= number_to_currency(grouped["income"].sum(&:amount_cents), unit: currency_symbol(Current.family.currency), precision: 0) %>
          </span>
        </h3>
      </div>
      <div class="divide-y divide-secondary">
        <% grouped["income"].group_by(&:category).each do |category, items| %>
          <div class="px-4 py-2 bg-surface-inset">
            <span class="text-sm font-medium text-secondary"><%= category %></span>
          </div>
          <% items.each do |item| %>
            <%= render "household/line_items/line_item_row", item: item %>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Expenses Section %>
  <% if grouped["expense"]&.any? %>
    <div class="bg-container rounded-xl shadow-border-xs overflow-hidden">
      <div class="px-4 py-3 bg-red-50 border-b border-red-200 theme-dark:bg-red-900/20 theme-dark:border-red-800">
        <h3 class="font-semibold text-red-700 flex items-center gap-2 theme-dark:text-red-300">
          <%= icon("trending-down", class: "w-5 h-5") %>
          Gastos
          <span class="ml-auto text-lg">
            <%= number_to_currency(grouped["expense"].sum(&:amount_cents), unit: currency_symbol(Current.family.currency), precision: 0) %>
          </span>
        </h3>
      </div>
      <div class="divide-y divide-secondary">
        <% grouped["expense"].group_by(&:category).each do |category, items| %>
          <div class="px-4 py-2 bg-surface-inset">
            <span class="text-sm font-medium text-secondary"><%= category %></span>
          </div>
          <% items.each do |item| %>
            <%= render "household/line_items/line_item_row", item: item %>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
<% else %>
  <div class="bg-container rounded-xl p-8 text-center shadow-border-xs">
    <%= icon("list", class: "w-12 h-12 text-secondary mx-auto mb-4") %>
    <h3 class="text-lg font-semibold text-primary mb-2">Sin items para este período</h3>
    <p class="text-secondary mb-4">Agrega ingresos y gastos fijos para este mes.</p>
    <div class="flex items-center justify-center gap-3">
      <%= button_to "Copiar del mes anterior",
        copy_from_previous_household_line_items_path(period: period_param),
        method: :post,
        class: "px-4 py-2 border border-secondary rounded-lg hover:bg-container-inset transition-colors" %>
      <%= render DS::Link.new(
        text: "Agregar Item",
        href: new_household_line_item_path(period: period_param),
        variant: "primary"
      ) %>
    </div>
  </div>
<% end %>

