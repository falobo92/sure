<%# locals: (category:, categories:) %>

<div data-controller="category" data-category-preset-colors-value="<%= Category::COLORS %>">
  <%= styled_form_with model: category, class: "space-y-6" do |f| %>
    <%# Secci√≥n de personalizaci√≥n visual %>
    <section class="space-y-6">
      <%# Avatar con editor de personalizaci√≥n %>
      <div class="flex flex-col items-center gap-4 py-6 px-4 bg-surface-inset rounded-2xl">
        <div class="w-fit relative">
          <%= render partial: "color_avatar", locals: { category: category } %>

          <details data-category-target="details" data-action="mousedown->category#handleOutsideClick">
            <summary class="cursor-pointer absolute -bottom-1 -right-1 flex justify-center items-center 
                           bg-container hover:bg-container-hover border border-secondary 
                           w-8 h-8 rounded-xl text-secondary hover:text-primary
                           shadow-sm hover:shadow-md transition-all duration-200">
              <%= icon("pen", size: "sm") %>
            </summary>

            <%# Popup de personalizaci√≥n mejorado %>
            <div class="fixed right-0 sm:right-auto mx-2 sm:ml-8 sm:mr-0 mt-3 z-50 
                        bg-container p-5 border border-secondary rounded-2xl shadow-border-lg 
                        backdrop-blur-sm" 
                 data-category-target="popup">
              
              <%# Selector de colores %>
              <div class="flex gap-3 flex-col mb-5" data-category-target="selection" style="<%= "display:none;" if @category.subcategory? %>">
                <div data-category-target="pickerSection"></div>
                
                <div>
                  <h4 class="text-secondary text-xs font-semibold uppercase tracking-wide mb-3 flex items-center gap-2">
                    <%= icon("palette", size: "xs") %>
                    Color
                  </h4>
                  <div class="flex flex-wrap md:flex-nowrap gap-2 items-center p-2 bg-surface-inset rounded-xl" data-category-target="colorsSection">
                    <% Category::COLORS.each do |color| %>
                      <label class="relative group">
                        <%= f.radio_button :color, color, class: "sr-only peer", data: { action: "change->category#handleColorChange" } %>
                        <div class="w-7 h-7 rounded-lg cursor-pointer transition-all duration-200
                                    hover:scale-110 hover:shadow-md
                                    peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-900" 
                             style="background-color: <%= color %>"></div>
                      </label>
                    <% end %>
                    <label class="relative">
                      <%= f.radio_button :color, "custom-color", class: "sr-only peer", data: { category_target: "colorPickerRadioBtn"} %>
                      <div class="w-7 h-7 rounded-lg cursor-pointer transition-all duration-200
                                  hover:scale-110 hover:shadow-md
                                  peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-blue-500" 
                           data-category-target="pickerBtn" 
                           style="background: conic-gradient(red,orange,yellow,lime,green,teal,cyan,blue,indigo,purple,magenta,pink,red)"></div>
                    </label>
                  </div>
                </div>
                
                <%# Paleta personalizada %>
                <div class="flex gap-2 items-center hidden flex-col" data-category-target="paletteSection">
                  <div class="flex gap-3 items-center w-full p-2 bg-surface-inset rounded-xl">
                    <div class="w-8 h-8 rounded-lg cursor-pointer shadow-sm" 
                         style="background-color: <%= category.color %>" 
                         data-category-target="colorPreview"></div>
                    <%= f.text_field :color, data: { category_target: "colorInput"}, inline: true, class: "flex-1" %>
                    <button type="button" class="text-secondary hover:text-primary transition-colors">
                      <%= icon "palette", size: "md", data: { action: "click->category#toggleSections" } %>
                    </button>
                  </div>
                  <div data-category-target="validationMessage" class="hidden self-start flex gap-1 items-center text-xs text-destructive bg-red-tint-5 px-3 py-2 rounded-lg">
                    <%= icon("alert-circle", size: "xs") %>
                    <span>Contraste bajo, elige un color m√°s oscuro o</span>
                    <button type="button" class="underline cursor-pointer font-medium" data-action="category#autoAdjust">auto-ajustar</button>
                  </div>
                </div>
              </div>

              <%# Selector de iconos %>
              <div class="flex flex-wrap gap-2 justify-center flex-col w-auto md:w-[350px]">
                <h4 class="text-secondary text-xs font-semibold uppercase tracking-wide mb-2 flex items-center gap-2">
                  <%= icon("shapes", size: "xs") %>
                  Icono
                </h4>
                <div class="flex flex-wrap gap-1 p-2 bg-surface-inset rounded-xl max-h-48 overflow-y-auto">
                  <% Category.icon_codes.each do |ico| %>
                    <label class="relative">
                      <%= f.radio_button :lucide_icon, ico, class: "sr-only peer", data: { action: "change->category#handleIconChange change->category#handleIconColorChange", category_target:"icon" } %>
                      <div class="text-secondary w-8 h-8 flex items-center justify-center rounded-lg cursor-pointer 
                                  transition-all duration-200
                                  hover:bg-container-hover hover:text-primary hover:scale-105
                                  peer-checked:bg-container peer-checked:text-primary peer-checked:shadow-sm
                                  border border-transparent peer-checked:border-secondary">
                        <%= icon(ico, size: "sm", color: "current") %>
                      </div>
                    </label>
                  <% end %>
                </div>
              </div>
            </div>
          </details>
        </div>
        
        <p class="text-xs text-secondary text-center">Haz clic en el √≠cono del l√°piz para personalizar</p>
      </div>

      <%# Mensajes de error %>
      <% if category.errors.any? %>
        <div class="animate-shake">
          <%= render "shared/form_errors", model: category %>
        </div>
      <% end %>

      <%# Campos del formulario %>
      <div class="space-y-4">
        <%# Clasificaci√≥n %>
        <div class="form-field">
          <label class="form-field__label flex items-center gap-1.5">
            <%= icon("tag", size: "xs", class: "text-subdued") %>
            Clasificaci√≥n
          </label>
          <%= f.select :classification, [["üí∞ Ingreso", "income"], ["üí∏ Gasto", "expense"]], 
                       { label: false }, 
                       { required: true, class: "form-field__input" } %>
        </div>
        
        <%# Nombre %>
        <div class="form-field">
          <label class="form-field__label flex items-center gap-1.5">
            <%= icon("type", size: "xs", class: "text-subdued") %>
            Nombre
          </label>
          <%= f.text_field :name, 
                           placeholder: t(".placeholder"), 
                           required: true, 
                           autofocus: true, 
                           label: false, 
                           class: "form-field__input",
                           data: { color_avatar_target: "name" } %>
        </div>
        
        <%# Categor√≠a padre %>
        <% unless category.parent? %>
          <div class="form-field">
            <label class="form-field__label flex items-center gap-1.5">
              <%= icon("git-branch", size: "xs", class: "text-subdued") %>
              Categor√≠a padre (opcional)
            </label>
            <%= f.select :parent_id, 
                         categories.pluck(:name, :id), 
                         { include_blank: "‚Äî Sin categor√≠a padre ‚Äî", label: false }, 
                         { disabled: category.parent?, 
                           class: "form-field__input",
                           data: { action: "change->category#handleParentChange" } } %>
            <p class="text-xs text-subdued mt-1">Agrupa esta categor√≠a bajo otra existente</p>
          </div>
        <% end %>
      </div>
    </section>

    <%# Bot√≥n de env√≠o %>
    <section class="pt-2">
      <%= hidden_field_tag :transaction_id, params[:transaction_id] %>
      <%= f.submit class: "w-full" %>
    </section>
  <% end %>
</div>
